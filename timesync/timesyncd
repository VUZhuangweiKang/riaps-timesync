#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import sys
import os
import time
import logging
import datetime
import subprocess

def sleep():
    """Intelligent sleep, based on conditions"""
    interval = 10.0
    now = datetime.datetime.now()
    if now.year < 2018:
        interval = 1.0
    time.sleep(interval)

def get_control_host_addrs():
    """Return a list of ip addressed of the current control host"""
    helper = "/usr/local/bin/riaps_ctrl_host"
    try:
        proc = subprocess.Popen(helper, stdout=subprocess.PIPE)
        out, err = proc.communicate()
        logging.info(out)
    except Exception as e:
        logging.warn("exec error %s: %s", helper, str(e))

def main():
    """Life starts here"""
    logging.basicConfig(format='%(levelname)s:%(message)s',
                        level=logging.INFO)
    while True:
        get_control_host_addrs()
        sleep()

if __name__ == "__main__":
    main()

# RIAPS_TIMESYNC_START - DO NOT EDIT THIS SECTION
#refclock PPS /dev/pps0 refid PPS lock NMEA 
#refclock SHM 0 offset 0.212 delay 0.2 precision 1e-1 refid NMEA noselect
#server <control_host> iburst
# RIAPS_TIMESYNC_END 
